/**
 * [zipacker]{@link https://github.com/emn178/zipacker}
 *
 * @version 0.1.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2016
 * @license MIT
 */
(function(){function b(a){this.options=a||{};this.options.zipFile=this.options.zipFile||"download.zip";this.options.quota=this.options.quota||1073741824;this.tasks={};"onDownloading onDownloaded onRequestedQuota onRequestedFileSystem onOpenedFile onCreatedFile onError onZipping onZipped onZippedBlob".split(" ").forEach(function(a){this[a]=this[a].bind(this)}.bind(this))}var f=window.requestFileSystem||window.webkitRequestFileSystem,e=navigator.webkitTemporaryStorage;b.prototype.add=function(a,b){var d=
this.tasks;b=b||"";if(!Array.isArray(a)){if("object"==typeof a){for(var c in a)d[c]||(d[c]=[]),d[c].push(a[c]);return}a=[a]}a.forEach(function(a){var c=a.split("/"),c=b+c[c.length-1];d[a]||(d[a]=[]);d[a].push(c)})};b.prototype.createZipFileSystem=function(){var a=new zip.fs.FS,b;for(b in this.tasks)this.tasks[b].forEach(function(d){a.root.addHttpContent(d,b)});return a};b.prototype.onError=function(a){this.options.onError&&this.options.onError.call(this,a)};b.prototype.onZipping=function(a,b){this.options.onProgress&&
this.options.onProgress.call(this,a,b,"zip");this.options.onZipping&&this.options.onZipping.call(this,a,b)};b.prototype.onDone=function(){this.options.onZipped&&this.options.onZipped.call(this);this.options.onDone&&this.options.onDone.call(this)};b.prototype.onZipped=function(){this.onDone();location.href=this.fileEntry.toURL()};b.prototype.onZippedBlob=function(a){this.onDone();saveAs(a,this.options.zipFile)};b.prototype.onCreatedFile=function(a){var b=this.createZipFileSystem();this.fileEntry=a;
b.exportFileEntry(a,this.onZipped,this.onZipping,this.onError)};b.prototype.onOpenedFile=function(a){a.remove(function(){a.filesystem.root.getFile(this.options.zipFile,{create:!0},this.onCreatedFile)}.bind(this),this.onError)};b.prototype.onRequestedFileSystem=function(a){a.root.getFile(this.options.zipFile,{create:!0},this.onOpenedFile)};b.prototype.onRequestedQuota=function(a){f(TEMPORARY,a,this.onRequestedFileSystem,this.onError)};b.prototype.onDownloading=function(a,b){this.options.onProgress&&
this.options.onProgress.call(this,a,b,"download");this.options.onDownloading&&this.options.onDownloading.call(this,a,b)};b.prototype.onDownloaded=function(){this.options.onDownloaded&&this.options.onDownloaded.call(this);e?e.requestQuota(this.options.quota,this.onRequestedQuota,this.onError):this.createZipFileSystem().exportBlob(this.onZippedBlob,this.onZipping,this.onError)};b.prototype.download=function(){var a=Object.keys(this.tasks);preload({files:a,onProgress:this.onDownloading,onLoad:this.onDownloaded})};
window.Zipacker=b})();
